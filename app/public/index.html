<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网页截图 API - 调试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background: #f8f9fa;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid #e9ecef;
        }

        .header {
            background: #212529;
            color: #fff;
            padding: 20px 30px;
            border-bottom: 1px solid #343a40;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 500;
            margin: 0;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #212529;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #212529;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #495057;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
            transition: border-color 0.15s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
        }

        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%23343a40' d='M5 7L0 2h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
            cursor: pointer;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #212529;
        }

        .form-group textarea {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            min-height: 80px;
            resize: vertical;
        }

        .row {
            display: flex;
            gap: 20px;
        }

        .col {
            flex: 1;
        }

        button {
            background: #212529;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.15s;
        }

        button:hover {
            background: #343a40;
        }

        button:active {
            background: #495057;
        }

        .result {
            margin-top: 25px;
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .result.show {
            display: block;
        }

        .result img {
            max-width: 100%;
            border: 1px solid #ced4da;
            display: block;
        }

        .api-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            font-size: 13px;
        }

        .api-info code {
            background: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 12px;
        }

        .api-info pre {
            background: #e9ecef;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 8px;
            font-size: 12px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #6c757d;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #e9ecef;
            border-top: 3px solid #212529;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 12px 15px;
            border-radius: 4px;
            color: #721c24;
            font-size: 13px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            background: #28a745;
            color: #fff;
            font-size: 11px;
            border-radius: 3px;
            margin-left: 10px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .github-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            transition: background-color 0.15s;
        }

        .github-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .github-link svg {
            flex-shrink: 0;
        }

        .github-link span {
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            .github-link span {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>网页截图 API <span class="status">调试</span></h1>
                </div>
                <a href="https://github.com/rehiy/webshot" target="_blank" class="github-link" title="GitHub 项目地址">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    <span>项目地址</span>
                </a>
            </div>
        </div>
        <div class="content">


            <div class="section">
                <h2>截图参数</h2>
                <form id="screenshotForm">
                    <div class="form-group">
                        <label for="url">网页 URL</label>
                        <input type="url" id="url" name="url" placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label for="html">或 HTML 内容</label>
                        <textarea id="html" name="html" placeholder="<h1>Hello</h1><p>World</p>"></textarea>
                    </div>
                    <div class="row">
                        <div class="col form-group">
                            <label for="waitFor">等待策略</label>
                            <select id="waitFor" name="waitFor">
                                <option value="0">0 - load 事件</option>
                                <option value="1">1 - domcontentloaded 事件</option>
                                <option value="2">2 - networkidle0</option>
                                <option value="3000">>2 - 毫秒数</option>
                            </select>
                        </div>
                        <div class="col form-group">
                            <label for="device">设备类型</label>
                            <select id="device" name="device">
                                <option value="Desktop Chrome">Desktop Chrome</option>
                                <option value="iPhone 14 Pro">iPhone 14 Pro</option>
                                <option value="iPad Pro 11">iPad Pro 11</option>
                                <option value="Desktop Edge">Desktop Edge</option>
                                <option value="Desktop Firefox">Desktop Firefox</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="trimColor">去除背景色（十六进制，如 ffffff）</label>
                        <input type="text" id="trimColor" name="trimColor" placeholder="ffffff">
                    </div>
                    <div class="form-group">
                        <label for="cookies">Cookies（JSON 数组）</label>
                        <textarea id="cookies" name="cookies" placeholder='[{"name":"token","value":"xxx","domain":".example.com"}]'></textarea>
                    </div>
                    <div class="form-group">
                        <label for="evaluate">执行 JavaScript</label>
                        <textarea id="evaluate" name="evaluate" placeholder='document.body.style.backgroundColor = "#fff";'></textarea>
                    </div>
                    <div class="form-group">
                        <label for="watermark">盲水印文本</label>
                        <input type="text" id="watermark" name="watermark" placeholder="版权信息或标识">
                    </div>
                    <button type="submit">生成截图</button>
                </form>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>正在生成截图，请稍候...</p>
            </div>

            <div class="error" id="error"></div>

            <div class="result" id="result">
                <h2 style="color: #212529; font-size: 14px; font-weight: 600; margin-bottom: 15px; text-transform: uppercase;">截图结果</h2>
                <img id="screenshot" alt="截图">
                <div style="margin-top: 20px;">
                    <button type="button" id="extractBtn" style="padding: 8px 16px; background: #212529; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">提取盲水印</button>
                    <div id="watermarkResult" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
                        <strong>提取结果：</strong> <span id="watermarkText"></span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>API 文档</h2>
                <div class="api-info">
                    <p><strong>请求地址：</strong> <code id="apiUrl">POST http://HOST/TOKEN</code></p>
                    <p style="margin-top: 12px;"><strong>cURL 示例：</strong></p>
                    <pre id="curlExample">curl -X POST http://HOST/TOKEN \
  -H "Content-Type: application/json" \
  -d '{"url":"https://example.com"}' \
  -o screenshot.png</pre>
                </div>
            </div>
        </div>
    </div>
    <script>
        const form = document.getElementById('screenshotForm');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const screenshot = document.getElementById('screenshot');
        const error = document.getElementById('error');
        const apiUrl = document.getElementById('apiUrl');
        const curlExample = document.getElementById('curlExample');
        const extractBtn = document.getElementById('extractBtn');
        const watermarkResult = document.getElementById('watermarkResult');
        const watermarkText = document.getElementById('watermarkText');

        // 从 URL 路径中提取 token
        function getTokenFromPath() {
            const path = window.location.pathname;
            const parts = path.split('/').filter(p => p);
            return parts.length > 0 ? parts[0] : '';
        }

        const token = getTokenFromPath();

        function showError(message) {
            error.textContent = message;
            error.classList.add('show');
            setTimeout(() => error.classList.remove('show'), 5000);
        }

        function getApiBaseUrl() {
            let path = location.pathname;
            if (!path.endsWith('/')) {
                path += '/';
            }
            return location.origin + path;
        }

        function updateApiUrl() {
            const baseUrl = getApiBaseUrl();
            apiUrl.textContent = `POST ${baseUrl}`;
            curlExample.textContent = `curl -X POST ${baseUrl} \\
  -H "Content-Type: application/json" \\
  -d '{"url":"https://example.com"}' \\
  -o screenshot.png`;
        }

        // 页面加载时更新 API 文档
        updateApiUrl();

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!token) {
                showError('无法从 URL 中获取 Token');
                return;
            }

            const data = {
                url: document.getElementById('url').value,
                html: document.getElementById('html').value,
                waitFor: parseInt(document.getElementById('waitFor').value),
                device: document.getElementById('device').value,
                trimColor: document.getElementById('trimColor').value
            };

            // 解析 cookies
            const cookiesText = document.getElementById('cookies').value.trim();
            if (cookiesText) {
                try {
                    data.cookies = JSON.parse(cookiesText);
                } catch (e) {
                    showError('Cookies 格式错误，请使用有效的 JSON 数组');
                    return;
                }
            }

            // 添加 evaluate
            data.evaluate = document.getElementById('evaluate').value.trim();

            // 添加 watermark
            data.watermark = document.getElementById('watermark').value.trim();

            if (!data.url && !data.html) {
                showError('请输入 URL 或 HTML 内容');
                return;
            }

            loading.classList.add('show');
            result.classList.remove('show');
            error.classList.remove('show');

            try {
                const response = await fetch('', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`请求失败 (${response.status}): ${errorText}`);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                screenshot.src = url;
                result.classList.add('show');
            } catch (err) {
                showError(err.message);
            } finally {
                loading.classList.remove('show');
            }
        });

        // 提取水印功能
        extractBtn.addEventListener('click', async () => {
            if (!token) {
                showError('无法从 URL 中获取 Token');
                return;
            }

            if (!screenshot.src) {
                showError('请先生成截图');
                return;
            }

            // 将截图转为 base64
            const response = await fetch(screenshot.src);
            const blob = await response.blob();
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const base64data = reader.result.split(',')[1];

                try {
                    const res = await fetch('./extract', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64data })
                    });

                    const data = await res.json();
                    if (data.watermark) {
                        watermarkText.textContent = data.watermark;
                        watermarkResult.style.display = 'block';
                    } else {
                        watermarkText.textContent = '未检测到水印';
                        watermarkResult.style.display = 'block';
                    }
                } catch (err) {
                    showError('提取失败: ' + err.message);
                }
            };
        });
    </script>
</body>

</html>